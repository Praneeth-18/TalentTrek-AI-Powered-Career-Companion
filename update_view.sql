CREATE OR REPLACE VIEW user_applications_with_history AS SELECT ua.id AS application_id, u.id AS user_id, u.email, u.name, jl.id AS job_listing_id, jl.position_title, jl.company, jl.location, jl.job_category, ua.current_status, ua.applied_at, ua.updated_at, ua.notes, COALESCE(( SELECT json_agg(json_build_object('id', ash.id, 'status', ash.status, 'changed_at', ash.changed_at, 'notes', ash.notes) ORDER BY ash.changed_at DESC) FROM application_status_history ash WHERE ash.user_application_id = ua.id), '[]'::json) AS status_history FROM user_applications ua JOIN users u ON ua.user_id = u.id JOIN job_listings jl ON ua.job_listing_id = jl.id;
